# 通用聊天机器人接口（UCBI）

UCBI 是一个处于 UCB 接口层的接口约定，它对上层提供统一的交互接口，对下层的不同服务平台进行适配，从而使上下层之间解耦。注意，UCBI 只是一个抽象的协议，只描述对外的表现，并不关心具体的实现方式。

由于聊天机器人是一种双向的通信，用户向机器人发消息通常表现为一个「事件」，机器人向用户发消息通常表现为一个「接口调用」，因此 UCBI 主要在这两方面进行统一化。

为了使语言不成为开发的障碍，UCBI 约定通过 HTTP 与上层通信，而与下层之间，可以使用 HTTP 也可以直接使用语言或平台限定的相应 SDK（如果使用后者，则此实现将同时也属于 UCB 翻译层）。

接口调用一般就是上层应用对 UCBI 的 HTTP 接口的调用。而事件的通知可以通过两种方式进行，一种是由 UCBI 通过一个 POST URL 来直接上报事件，另一种是由上层应用通过长轮询来主动获取。

另外，数据格式方面，事件和接口调用统一使用 JSON 作为数据交换格式，而不使用 HTTP 表单的形式。

下面从事件和接口调用两个方面来设计统一化协议。

## 事件

### 事件的分类

首先，将事件分为三类，分别为「消息 message」「通知 notice」「请求 request」。

「消息」类型的事件，是 UCBI 着重进行统一化的事件，顾名思义，这个类型就是用户发送的消息，这种事件在普通用户的客户端上通常表现为在聊天界面显示的气泡中的内容，可以是纯文本、图片、图文混杂，也可以是音频、视频、链接分享等富媒体形式，UCBI 通过可扩展的消息表示方式来防止部分特殊类型的消息无法表示。

「通知」类型的事件对于不同消息平台差别可能较大，UCBI 会对其中最常见的一些进行统一化，如成功添加好友、新成员入群等，这类事件在用户的客户端上通常表现为显示在聊天界面中但和消息明显区分的样式。

「请求」类型的事件表现在用户客户端上通常为聊天界面之外的其它界面，如加好友请求、加群请求等，它们和**聊天**机器人这件事本身关联不大，并且需要一种方式来唯一标记请求，不同的一、二层程序（翻译层和服务层）会有非常不同的做法，因此统一化的意义不大。

### JSON 数据格式

下面，定义事件的 JSON 格式。

#### 根对象

首先最外层是一个 JSON 对象，对象中固定有以下几个字段：

| 字段名 | 数据类型 | 可选值 | 说明 |
| ----- | ------- | ----- | --- |
| `type` | string | `"message"`、`"notice"` | 事件类型，对应前面的事件分类 |
| `time` | number | - | 事件发生的时间戳 |
| `context` | object | - | 事件发生的上下文，通过这项必须可以直接唯一确定回复时的发送目标，若无上下文，则 `null` |
| `data` | object | - | 事件的实际信息，随事件类型的不同而不同 |

#### Context 字段

`context` 的内容如下：

| 字段名 | 数据类型 | 可选值 | 说明 |
| ----- | ------- | ----- | --- |
| `platform` | string | - | 聊天平台名称，如 `wechat`、`slack` |
| `via` | string | - | 翻译层程序名称，如 `coolq-http-api`、`mojo-weixin-openwx` |
| `config_id` | string | - | 配置 ID |
| `type` | string | `"private"`、`"group"`、<br>`"discuss"` | 上下文类型，分别为私聊、群组、讨论组 |
| `user_id` | string | - | 发送者 ID |
| `user_tid` | string | - | 发送者临时 ID |
| `group_id` | string | - | 群组 ID |
| `group_tid` | string | - | 群组临时 ID |
| `discuss_id` | string | - | 讨论组 ID |
| `discuss_tid` | string | - | 讨论组临时 ID |

由于某些服务层无法提供真实的用户 ID，而只能提供一个临时的、重启失效的 ID（如 [Mojo-Weixin](https://github.com/sjdy521/Mojo-Weixin)），所以这里也允许使用 `xxx_tid` 来取代 `xxx_id`，但无论如何，此处至少有 `xxx_id` 和 `xxx_tid` 其中之一，否则应认为无上下文，对 `context` 置 `null`。

`context` 字段的内容应当能够直接传给后面「接口调用」的消息发送接口来作为发送目标。

`config_id` 用于标记 UCBI 实现的配置文件中的消息接收源的配置 ID。因为 UCBI 支持同时接入多个翻译层、多个账号，为了能够正确找到当前所需要的适配器，应该有一个唯一的标识来确定和翻译层有关的配置信息。

当 `type` 为 `"group"` 或 `"discuss"` 时，最好同时也给出 `user_id` 或 `user_tid`，来标记消息／通知的发送／触发者。

#### Data 字段

`data` 字段中的某些内容会和 `context` 有所重复，以便于使用。

「消息」类型的 `data` 内容如下：

| 字段名 | 数据类型 | 可选值 | 说明 | 备注 |
| ----- | ------- | ----- | --- | --- |
| `type` | string | `"private"`、`"group"`、<br>`"discuss"` | 消息类型，分别为私聊、群组、讨论组 | - |
| `sender_id` | string | - | 发送者 ID | - |
| `sender_tid` | string | - | 发送者临时 ID | - |
| `sender_name` | string | - | 发送者昵称／用户名 | - |
| `sender_markname` | string | - | 发送者备注名 | 可选 |
| `sender` | string | - | 发送者显示名（当有备注名时为备注名，否则为昵称／用户名） | - |
| `group_id` | string | - | 群组 ID |
| `group_tid` | string | - | 群组临时 ID |
| `group_name` | string | - | 群组名称 | - |
| `group_markname` | string | - | 群组备注名 | 可选 |
| `group` | string | - | 群组显示名（当有备注名时为备注名，否则为群组真实名称） | - |
| `discuss_id` | string | - | 讨论组 ID |
| `discuss_tid` | string | - | 讨论组临时 ID |
| `discuss_name` | string | - | 讨论组名称 | - |
| `discuss_markname` | string | - | 讨论组备注名 | 可选 |
| `discuss` | string | - | 讨论组显示名（当有备注名时为备注名，否则为讨论组真实名称） | - |
| `message` | TODO
| 额外字段 | - | - | 某些翻译层特有的信息，字段名应以翻译层程序名称加空格开头 | 可选

「通知」类型的 `data` 内容如下：

TODO

## 接口调用

TODO
